var fs = require("fs");
var pathExists = require("path-exists");
var jwt = require("jsonwebtoken");
var uuid = require('uuid');
var outputFileSync = require('output-file-sync');
function initsysid(serialPath, seri) {
    var serial;
    if (seri) {
        serial = seri;
    }
    else {
        serial = uuid.v4();
    }
    var secret = uuid.v4() + uuid.v4();
    outputFileSync(serialPath + '/.secret', secret, 'utf-8');
    outputFileSync(serialPath + '/serial', serial, 'utf-8');
    return { serial: serial, secret: secret };
}
function readSerial(serialPath) {
    return fs.readFileSync(serialPath + '/serial', 'utf8');
}
function readSecret(serialPath) {
    return fs.readFileSync(serialPath + '/.secret', 'utf8');
}
function readTracker(serialPath) {
    return fs.readFileSync(serialPath + '/.tracker', 'utf8');
}
function readJson(serialPath) {
    var config = {};
    config.secret = readSecret(serialPath);
    config.serial = readSerial(serialPath);
    if (pathExists.sync(serialPath + '/.tracker')) {
        config.tracker = readTracker(serialPath);
    }
    return config;
}
var SysID = (function () {
    function SysID(dir, options) {
        var config;
        if (dir) {
            this.dir = dir;
        }
        else {
            throw new Error('wrong dir');
        }
        if (!options)
            options = {};
        this.tracker = false;
        if (!pathExists.sync(this.dir + '/serial')) {
            config = initsysid(this.dir, options.serial);
        }
        else {
            config = readJson(this.dir);
        }
        for (var c = 0; c < Object.keys(config).length; c++) {
            this[Object.keys(config)[c]] = config[Object.keys(config)[c]];
        }
    }
    SysID.prototype.read = function () {
        return readJson(this.dir);
    };
    ;
    SysID.prototype.decode = function () {
        return jwt.verify(this.tracker, this.secret);
    };
    ;
    SysID.prototype.auth = function () {
        var code = jwt.verify(this.tracker, this.secret);
        code.serial = readSerial(this.dir);
        return code;
    };
    ;
    SysID.prototype.sign = function (json) {
        var token = jwt.sign(json, this.secret);
        return token;
    };
    ;
    SysID.prototype.verify = function (token, maxAge) {
        try {
            if (maxAge) {
                var decoded = jwt.verify(token, this.secret, { maxAge: maxAge });
            }
            else {
                var decoded = jwt.verify(token, this.secret);
            }
            return decoded;
        }
        catch (err) {
            return err;
        }
    };
    ;
    SysID.prototype.validate = function (serial, objectkey) {
        if (!this.tracker) {
            var config = {
                secret: this.secret
            };
            if (objectkey.serial) {
                this.serial = objectkey.serial;
                outputFileSync(this.dir + '/serial', this.serial, 'utf-8');
                delete objectkey.serial;
            }
            var token = jwt.sign(objectkey, this.secret, { noTimestamp: true });
            outputFileSync(this.dir + '/.tracker', token, 'utf-8');
            this.tracker = token;
        }
        else {
            throw new Error('wrong serial or just validated');
        }
    };
    ;
    return SysID;
})();
module.exports = SysID;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbImluaXRzeXNpZCIsInJlYWRTZXJpYWwiLCJyZWFkU2VjcmV0IiwicmVhZFRyYWNrZXIiLCJyZWFkSnNvbiIsIlN5c0lEIiwiU3lzSUQuY29uc3RydWN0b3IiLCJTeXNJRC5yZWFkIiwiU3lzSUQuZGVjb2RlIiwiU3lzSUQuYXV0aCIsIlN5c0lELnNpZ24iLCJTeXNJRC52ZXJpZnkiLCJTeXNJRC52YWxpZGF0ZSJdLCJtYXBwaW5ncyI6IkFBQUEsSUFBWSxFQUFFLFdBQU0sSUFBSSxDQUFDLENBQUE7QUFFekIsSUFBWSxVQUFVLFdBQU0sYUFBYSxDQUFDLENBQUE7QUFDMUMsSUFBWSxHQUFHLFdBQU0sY0FBYyxDQUFDLENBQUE7QUFFcEMsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzNCLElBQUksY0FBYyxHQUFHLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0FBR2pELG1CQUFtQixVQUFrQixFQUFFLElBQWE7SUFDaERBLElBQUlBLE1BQWNBLENBQUNBO0lBQ25CQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNQQSxNQUFNQSxHQUFHQSxJQUFJQSxDQUFDQTtJQUNsQkEsQ0FBQ0E7SUFBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDSkEsTUFBTUEsR0FBR0EsSUFBSUEsQ0FBQ0EsRUFBRUEsRUFBRUEsQ0FBQ0E7SUFDdkJBLENBQUNBO0lBRURBLElBQUlBLE1BQU1BLEdBQVdBLElBQUlBLENBQUNBLEVBQUVBLEVBQUVBLEdBQUdBLElBQUlBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO0lBRTNDQSxjQUFjQSxDQUFDQSxVQUFVQSxHQUFHQSxVQUFVQSxFQUFFQSxNQUFNQSxFQUFFQSxPQUFPQSxDQUFDQSxDQUFDQTtJQUN6REEsY0FBY0EsQ0FBQ0EsVUFBVUEsR0FBR0EsU0FBU0EsRUFBRUEsTUFBTUEsRUFBRUEsT0FBT0EsQ0FBQ0EsQ0FBQ0E7SUFFeERBLE1BQU1BLENBQUNBLEVBQUVBLE1BQU1BLEVBQUVBLE1BQU1BLEVBQUVBLE1BQU1BLEVBQUVBLE1BQU1BLEVBQUVBLENBQUFBO0FBQzdDQSxDQUFDQTtBQUVELG9CQUFvQixVQUFrQjtJQUVsQ0MsTUFBTUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsVUFBVUEsR0FBR0EsU0FBU0EsRUFBRUEsTUFBTUEsQ0FBQ0EsQ0FBQUE7QUFFMURBLENBQUNBO0FBQ0Qsb0JBQW9CLFVBQWtCO0lBRWxDQyxNQUFNQSxDQUFDQSxFQUFFQSxDQUFDQSxZQUFZQSxDQUFDQSxVQUFVQSxHQUFHQSxVQUFVQSxFQUFFQSxNQUFNQSxDQUFDQSxDQUFBQTtBQUUzREEsQ0FBQ0E7QUFDRCxxQkFBcUIsVUFBa0I7SUFFbkNDLE1BQU1BLENBQUNBLEVBQUVBLENBQUNBLFlBQVlBLENBQUNBLFVBQVVBLEdBQUdBLFdBQVdBLEVBQUVBLE1BQU1BLENBQUNBLENBQUFBO0FBRTVEQSxDQUFDQTtBQUNELGtCQUFrQixVQUFVO0lBQ3hCQyxJQUFJQSxNQUFNQSxHQUFVQSxFQUFFQSxDQUFDQTtJQUV2QkEsTUFBTUEsQ0FBQ0EsTUFBTUEsR0FBR0EsVUFBVUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQ0E7SUFDdkNBLE1BQU1BLENBQUNBLE1BQU1BLEdBQUdBLFVBQVVBLENBQUNBLFVBQVVBLENBQUNBLENBQUFBO0lBQ3RDQSxFQUFFQSxDQUFDQSxDQUFDQSxVQUFVQSxDQUFDQSxJQUFJQSxDQUFDQSxVQUFVQSxHQUFHQSxXQUFXQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUM1Q0EsTUFBTUEsQ0FBQ0EsT0FBT0EsR0FBR0EsV0FBV0EsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQUE7SUFFNUNBLENBQUNBO0lBRURBLE1BQU1BLENBQUNBLE1BQU1BLENBQUFBO0FBRWpCQSxDQUFDQTtBQWlCRDtJQU1JQyxlQUFZQSxHQUFXQSxFQUFFQSxPQUFjQTtRQUVuQ0MsSUFBSUEsTUFBYUEsQ0FBQ0E7UUFFbEJBLEVBQUVBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBO1lBQ05BLElBQUlBLENBQUNBLEdBQUdBLEdBQUdBLEdBQUdBLENBQUNBO1FBRW5CQSxDQUFDQTtRQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUNKQSxNQUFNQSxJQUFJQSxLQUFLQSxDQUFDQSxXQUFXQSxDQUFDQSxDQUFBQTtRQUVoQ0EsQ0FBQ0E7UUFDREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsT0FBT0EsQ0FBQ0E7WUFBQ0EsT0FBT0EsR0FBR0EsRUFBRUEsQ0FBQUE7UUFDMUJBLElBQUlBLENBQUNBLE9BQU9BLEdBQUdBLEtBQUtBLENBQUNBO1FBRXJCQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxVQUFVQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxHQUFHQSxHQUFHQSxTQUFTQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUV6Q0EsTUFBTUEsR0FBR0EsU0FBU0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsRUFBRUEsT0FBT0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7UUFDakRBLENBQUNBO1FBQUNBLElBQUlBLENBQUNBLENBQUNBO1lBQ0pBLE1BQU1BLEdBQUdBLFFBQVFBLENBQUNBLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO1FBQ2hDQSxDQUFDQTtRQUVEQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQSxNQUFNQSxFQUFFQSxDQUFDQSxFQUFFQSxFQUFFQSxDQUFDQTtZQUNsREEsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FB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QVdBLEVBQUVBLEtBQUtBLEVBQUVBLE9BQU9BLENBQUNBLENBQUNBO1lBQ3ZEQSxJQUFJQSxDQUFDQSxPQUFPQSxHQUFHQSxLQUFLQSxDQUFBQTtRQUd4QkEsQ0FBQ0E7UUFBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDSkEsTUFBTUEsSUFBSUEsS0FBS0EsQ0FBQ0EsZ0NBQWdDQSxDQUFDQSxDQUFBQTtRQUNyREEsQ0FBQ0E7SUFNTEEsQ0FBQ0E7O0lBSUxQLFlBQUNBO0FBQURBLENBMUZBLEFBMEZDQSxJQUFBO0FBS0QsaUJBQVMsS0FBSyxDQUFBIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzXCI7XG5cbmltcG9ydCAqIGFzIHBhdGhFeGlzdHMgZnJvbSBcInBhdGgtZXhpc3RzXCI7XG5pbXBvcnQgKiBhcyBqd3QgZnJvbSBcImpzb253ZWJ0b2tlblwiO1xuXG5sZXQgdXVpZCA9IHJlcXVpcmUoJ3V1aWQnKTtcbmxldCBvdXRwdXRGaWxlU3luYyA9IHJlcXVpcmUoJ291dHB1dC1maWxlLXN5bmMnKTtcblxuXG5mdW5jdGlvbiBpbml0c3lzaWQoc2VyaWFsUGF0aDogc3RyaW5nLCBzZXJpPzogc3RyaW5nKTogeyBzZXJpYWw6IHN0cmluZzsgc2VjcmV0OiBzdHJpbmcgfSB7XG4gICAgbGV0IHNlcmlhbDogc3RyaW5nO1xuICAgIGlmIChzZXJpKSB7XG4gICAgICAgIHNlcmlhbCA9IHNlcmk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgc2VyaWFsID0gdXVpZC52NCgpO1xuICAgIH1cblxuICAgIGxldCBzZWNyZXQ6IHN0cmluZyA9IHV1aWQudjQoKSArIHV1aWQudjQoKTtcblxuICAgIG91dHB1dEZpbGVTeW5jKHNlcmlhbFBhdGggKyAnLy5zZWNyZXQnLCBzZWNyZXQsICd1dGYtOCcpO1xuICAgIG91dHB1dEZpbGVTeW5jKHNlcmlhbFBhdGggKyAnL3NlcmlhbCcsIHNlcmlhbCwgJ3V0Zi04Jyk7XG5cbiAgICByZXR1cm4geyBzZXJpYWw6IHNlcmlhbCwgc2VjcmV0OiBzZWNyZXQgfVxufVxuXG5mdW5jdGlvbiByZWFkU2VyaWFsKHNlcmlhbFBhdGg6IHN0cmluZykge1xuXG4gICAgcmV0dXJuIGZzLnJlYWRGaWxlU3luYyhzZXJpYWxQYXRoICsgJy9zZXJpYWwnLCAndXRmOCcpXG5cbn1cbmZ1bmN0aW9uIHJlYWRTZWNyZXQoc2VyaWFsUGF0aDogc3RyaW5nKSB7XG5cbiAgICByZXR1cm4gZnMucmVhZEZpbGVTeW5jKHNlcmlhbFBhdGggKyAnLy5zZWNyZXQnLCAndXRmOCcpXG5cbn1cbmZ1bmN0aW9uIHJlYWRUcmFja2VyKHNlcmlhbFBhdGg6IHN0cmluZykge1xuXG4gICAgcmV0dXJuIGZzLnJlYWRGaWxlU3luYyhzZXJpYWxQYXRoICsgJy8udHJhY2tlcicsICd1dGY4JylcblxufVxuZnVuY3Rpb24gcmVhZEpzb24oc2VyaWFsUGF0aCkge1xuICAgIGxldCBjb25maWcgPSA8SUpzb24+e307XG5cbiAgICBjb25maWcuc2VjcmV0ID0gcmVhZFNlY3JldChzZXJpYWxQYXRoKTtcbiAgICBjb25maWcuc2VyaWFsID0gcmVhZFNlcmlhbChzZXJpYWxQYXRoKVxuICAgIGlmIChwYXRoRXhpc3RzLnN5bmMoc2VyaWFsUGF0aCArICcvLnRyYWNrZXInKSkge1xuICAgICAgICBjb25maWcudHJhY2tlciA9IHJlYWRUcmFja2VyKHNlcmlhbFBhdGgpXG5cbiAgICB9XG5cbiAgICByZXR1cm4gY29uZmlnXG5cbn1cblxuaW50ZXJmYWNlIElKc29uIHtcbiAgICBzZWNyZXQ6IHN0cmluZztcbiAgICBzZXJpYWw6IHN0cmluZztcbiAgICB0cmFja2VyPzogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgSWlkIHtcbiAgICBkaXI6IHN0cmluZztcbiAgICB0cmFja2VyPzogYm9vbGVhbjtcblxufVxuaW50ZXJmYWNlIElvcHQge1xuICAgIHRyYWNrZXI/OiBib29sZWFuO1xuICAgIHNlcmlhbD86IHN0cmluZ1xufVxuY2xhc3MgU3lzSUQge1xuICAgIGRpcjogc3RyaW5nO1xuICAgIHRyYWNrZXI6IGFueTtcbiAgICBzZWNyZXQ6IHN0cmluZztcbiAgICBzZXJpYWw6IHN0cmluZztcblxuICAgIGNvbnN0cnVjdG9yKGRpcjogc3RyaW5nLCBvcHRpb25zPzogSW9wdCkge1xuXG4gICAgICAgIGxldCBjb25maWc6IElKc29uO1xuXG4gICAgICAgIGlmIChkaXIpIHtcbiAgICAgICAgICAgIHRoaXMuZGlyID0gZGlyO1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3dyb25nIGRpcicpXG5cbiAgICAgICAgfVxuICAgICAgICBpZiAoIW9wdGlvbnMpIG9wdGlvbnMgPSB7fVxuICAgICAgICB0aGlzLnRyYWNrZXIgPSBmYWxzZTtcblxuICAgICAgICBpZiAoIXBhdGhFeGlzdHMuc3luYyh0aGlzLmRpciArICcvc2VyaWFsJykpIHtcblxuICAgICAgICAgICAgY29uZmlnID0gaW5pdHN5c2lkKHRoaXMuZGlyLCBvcHRpb25zLnNlcmlhbCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25maWcgPSByZWFkSnNvbih0aGlzLmRpcik7XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKHZhciBjID0gMDsgYyA8IE9iamVjdC5rZXlzKGNvbmZpZykubGVuZ3RoOyBjKyspIHtcbiAgICAgICAgICAgIHRoaXNbT2JqZWN0LmtleXMoY29uZmlnKVtjXV0gPSBjb25maWdbT2JqZWN0LmtleXMoY29uZmlnKVtjXV07XG4gICAgICAgIH1cbiAgICB9XG5cblxuICAgIHJlYWQoKSB7XG4gICAgICAgIHJldHVybiByZWFkSnNvbih0aGlzLmRpcilcbiAgICB9O1xuICAgIGRlY29kZSgpIHtcbiAgICAgICAgcmV0dXJuIGp3dC52ZXJpZnkodGhpcy50cmFja2VyLCB0aGlzLnNlY3JldCk7XG4gICAgfTtcbiAgICBhdXRoKCkge1xuICAgICAgICB2YXIgY29kZSA9IGp3dC52ZXJpZnkodGhpcy50cmFja2VyLCB0aGlzLnNlY3JldClcbiAgICAgICAgY29kZS5zZXJpYWwgPSByZWFkU2VyaWFsKHRoaXMuZGlyKVxuICAgICAgICByZXR1cm4gY29kZTtcbiAgICB9O1xuICAgIHNpZ24oanNvbikge1xuICAgICAgICB2YXIgdG9rZW4gPSBqd3Quc2lnbihqc29uLCB0aGlzLnNlY3JldCk7XG4gICAgICAgIHJldHVybiB0b2tlblxuICAgIH07XG4gICAgdmVyaWZ5KHRva2VuLCBtYXhBZ2UpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGlmIChtYXhBZ2UpIHtcbiAgICAgICAgICAgICAgICB2YXIgZGVjb2RlZCA9IGp3dC52ZXJpZnkodG9rZW4sIHRoaXMuc2VjcmV0LCB7IG1heEFnZTogbWF4QWdlIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB2YXIgZGVjb2RlZCA9IGp3dC52ZXJpZnkodG9rZW4sIHRoaXMuc2VjcmV0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBkZWNvZGVkXG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgcmV0dXJuIGVyclxuICAgICAgICB9XG4gICAgfTtcblxuICAgIHZhbGlkYXRlKHNlcmlhbCwgb2JqZWN0a2V5KSB7XG5cbiAgICAgICAgaWYgKCF0aGlzLnRyYWNrZXIpIHtcbiAgICAgICAgICAgIHZhciBjb25maWcgPSB7XG4gICAgICAgICAgICAgICAgc2VjcmV0OiB0aGlzLnNlY3JldFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG9iamVjdGtleS5zZXJpYWwpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNlcmlhbCA9IG9iamVjdGtleS5zZXJpYWw7XG4gICAgICAgICAgICAgICAgb3V0cHV0RmlsZVN5bmModGhpcy5kaXIgKyAnL3NlcmlhbCcsIHRoaXMuc2VyaWFsLCAndXRmLTgnKTtcblxuICAgICAgICAgICAgICAgIGRlbGV0ZSBvYmplY3RrZXkuc2VyaWFsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIHRva2VuID0gand0LnNpZ24ob2JqZWN0a2V5LCB0aGlzLnNlY3JldCwgeyBub1RpbWVzdGFtcDogdHJ1ZSB9KTtcbiAgICAgICAgICAgIG91dHB1dEZpbGVTeW5jKHRoaXMuZGlyICsgJy8udHJhY2tlcicsIHRva2VuLCAndXRmLTgnKTtcbiAgICAgICAgICAgIHRoaXMudHJhY2tlciA9IHRva2VuXG4gICAgICAgICAgICAvLyByZXNldCBvYmplY3RcblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCd3cm9uZyBzZXJpYWwgb3IganVzdCB2YWxpZGF0ZWQnKVxuICAgICAgICB9XG5cblxuXG4gICAgICAgIC8vIHZhciBjb25maWc9cmVhZCBmaWxlIHNlcmlhbFxuXG4gICAgfTtcblxuXG5cbn1cblxuXG5cblxuZXhwb3J0ID0gU3lzSURcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
