var fs = require("fs");
var pathExists = require("path-exists");
var jwt = require("jsonwebtoken");
var uuid = require('uuid');
var outputFileSync = require('output-file-sync');
function initsysid(serialPath, seri) {
    var serial;
    if (seri) {
        serial = seri;
    }
    else {
        serial = uuid.v4();
    }
    var secret = uuid.v4() + uuid.v4();
    outputFileSync(serialPath + '/.secret', secret, 'utf-8');
    outputFileSync(serialPath + '/serial', serial, 'utf-8');
    return { serial: serial, secret: secret };
}
function readSerial(serialPath) {
    return fs.readFileSync(serialPath + '/serial', 'utf8');
}
function readSecret(serialPath) {
    return fs.readFileSync(serialPath + '/.secret', 'utf8');
}
function readTracker(serialPath) {
    return fs.readFileSync(serialPath + '/.tracker', 'utf8');
}
function readJson(serialPath) {
    var config = {};
    config.secret = readSecret(serialPath);
    config.serial = readSerial(serialPath);
    if (pathExists.sync(serialPath + '/.tracker')) {
        config.tracker = readTracker(serialPath);
    }
    return config;
}
var SysID = (function () {
    function SysID(dir, options) {
        var config;
        if (dir) {
            this.dir = dir;
        }
        else {
            throw new Error('wrong dir');
        }
        if (!options || !options.tracker) {
            this.tracker = false;
        }
        else if (options.tracker) {
            this.tracker = 'pending';
        }
        if (!pathExists.sync(this.dir + '/serial')) {
            config = initsysid(this.dir, options.serial);
        }
        else {
            config = readJson(this.dir);
        }
        for (var c = 0; c < Object.keys(config).length; c++) {
            this[Object.keys(config)[c]] = config[Object.keys(config)[c]];
        }
    }
    SysID.prototype.read = function () {
        return readJson(this.dir);
    };
    ;
    SysID.prototype.decode = function () {
        return jwt.verify(this.tracker, this.secret);
    };
    ;
    SysID.prototype.auth = function () {
        var code = jwt.verify(this.tracker, this.secret);
        code.serial = readSerial(this.dir);
        return code;
    };
    ;
    SysID.prototype.sign = function (json) {
        var token = jwt.sign(json, this.secret);
        return token;
    };
    ;
    SysID.prototype.verify = function (token, maxAge) {
        try {
            if (maxAge) {
                var decoded = jwt.verify(token, this.secret, { maxAge: maxAge });
            }
            else {
                var decoded = jwt.verify(token, this.secret);
            }
            return decoded;
        }
        catch (err) {
            return err;
        }
    };
    ;
    SysID.prototype.validate = function (serial, objectkey) {
        if (objectkey && serial == this.serial && this.tracker && this.tracker == 'pending') {
            var config = {
                secret: this.secret
            };
            if (objectkey.serial) {
                this.serial = objectkey.serial;
                outputFileSync(this.dir + '/serial', this.serial, 'utf-8');
                delete objectkey.serial;
            }
            var token = jwt.sign(objectkey, this.secret, { noTimestamp: true });
            outputFileSync(this.dir + '/.tracker', token, 'utf-8');
            this.tracker = token;
        }
        else {
            throw new Error('wrong serial or just validated');
        }
    };
    ;
    return SysID;
})();
module.exports = SysID;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbImluaXRzeXNpZCIsInJlYWRTZXJpYWwiLCJyZWFkU2VjcmV0IiwicmVhZFRyYWNrZXIiLCJyZWFkSnNvbiIsIlN5c0lEIiwiU3lzSUQuY29uc3RydWN0b3IiLCJTeXNJRC5yZWFkIiwiU3lzSUQuZGVjb2RlIiwiU3lzSUQuYXV0aCIsIlN5c0lELnNpZ24iLCJTeXNJRC52ZXJpZnkiLCJTeXNJRC52YWxpZGF0ZSJdLCJtYXBwaW5ncyI6IkFBQUEsSUFBWSxFQUFFLFdBQU0sSUFBSSxDQUFDLENBQUE7QUFFekIsSUFBWSxVQUFVLFdBQU0sYUFBYSxDQUFDLENBQUE7QUFDMUMsSUFBWSxHQUFHLFdBQU0sY0FBYyxDQUFDLENBQUE7QUFFcEMsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzNCLElBQUksY0FBYyxHQUFHLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0FBR2pELG1CQUFtQixVQUFrQixFQUFDLElBQVk7SUFDOUNBLElBQUlBLE1BQWFBLENBQUNBO0lBQ2xCQSxFQUFFQSxDQUFBQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFBQSxDQUFDQTtRQUNMQSxNQUFNQSxHQUFDQSxJQUFJQSxDQUFDQTtJQUNoQkEsQ0FBQ0E7SUFBQ0EsSUFBSUEsQ0FBQUEsQ0FBQ0E7UUFDSEEsTUFBTUEsR0FBQ0EsSUFBSUEsQ0FBQ0EsRUFBRUEsRUFBRUEsQ0FBQ0E7SUFDckJBLENBQUNBO0lBRURBLElBQUlBLE1BQU1BLEdBQVdBLElBQUlBLENBQUNBLEVBQUVBLEVBQUVBLEdBQUdBLElBQUlBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO0lBRTNDQSxjQUFjQSxDQUFDQSxVQUFVQSxHQUFHQSxVQUFVQSxFQUFFQSxNQUFNQSxFQUFFQSxPQUFPQSxDQUFDQSxDQUFDQTtJQUN6REEsY0FBY0EsQ0FBQ0EsVUFBVUEsR0FBR0EsU0FBU0EsRUFBRUEsTUFBTUEsRUFBRUEsT0FBT0EsQ0FBQ0EsQ0FBQ0E7SUFF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QUlBLENBQUNBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1FBQ2xFQSxDQUFDQTtJQUNMQSxDQUFDQTtJQUtERCxvQkFBSUEsR0FBSkE7UUFDSUUsTUFBTUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQUE7SUFDN0JBLENBQUNBOztJQUNERixzQkFBTUEsR0FBTkE7UUFDSUcsTUFBTUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsRUFBRUEsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7SUFDakRBLENBQUNBOztJQUNESCxvQkFBSUEsR0FBSkE7UUFDSUksSUFBSUEsSUFBSUEsR0FBR0EsR0FBR0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsRUFBRUEsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQUE7UUFDaERBLElBQUlBLENBQUNBLE1BQU1BLEdBQUdBLFVBQVVBLENBQUNBLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLENBQUFBO1FBQ2xDQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQTtJQUNoQkEsQ0FBQ0E7O0lBQ0RKLG9CQUFJQSxHQUFKQSxVQUFLQSxJQUFJQTtRQUNMSyxJQUFJQSxLQUFLQSxHQUFHQSxHQUFHQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxFQUFFQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQTtRQUN4Q0EsTUFBTUEsQ0FBQ0EsS0FBS0EsQ0FBQUE7SUFDaEJBLENBQUNBOztJQUNETCxzQkFBTUEsR0FBTkEsVUFBT0EsS0FBS0EsRUFBRUEsTUFBTUE7UUFDaEJNLElBQUlBLENBQUNBO1lBQ0RBLEVBQUVBLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBO2dCQUNUQSxJQUFJQSxPQUFPQSxHQUFHQSxHQUFHQSxDQUFDQSxNQUFNQSxDQUFDQSxLQUFLQSxFQUFFQSxJQUFJQSxDQUFDQSxNQUFNQSxFQUFFQSxFQUFFQSxNQUFNQSxFQUFFQSxNQUFNQSxFQUFFQSxDQUFDQSxDQUFDQTtZQUNyRUEsQ0FBQ0E7WUFBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7Z0JBQ0pBLElBQUlBLE9BQU9BLEdBQUdBLEdBQUdBLENBQUNBLE1BQU1BLENBQUNBLEtBQUtBLEVBQUVBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBO1lBQ2pEQSxDQUFDQTtZQUNEQSxNQUFNQSxDQUFDQSxPQUFPQSxDQUFBQTtRQUNsQkEsQ0FBRUE7UUFBQUEsS0FBS0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDWEEsTUFBTUEsQ0FBQ0EsR0FBR0EsQ0FBQUE7UUFDZEEsQ0FBQ0E7SUFDTEEsQ0FBQ0E7O0lBRUROLHdCQUFRQSxHQUFSQSxVQUFTQSxNQUFNQSxFQUFFQSxTQUFTQTtRQUd0Qk8sRUFBRUEsQ0FBQ0EsQ0FBQ0EsU0FBU0EsSUFBSUEsTUFBTUEsSUFBSUEsSUFBSUEsQ0FBQ0EsTUFBTUEsSUFBSUEsSUFBSUEsQ0FBQ0EsT0FBT0EsSUFBSUEsSUFBSUEsQ0FBQ0EsT0FBT0EsSUFBSUEsU0FBU0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDbEZBLElBQUlBLE1BQU1BLEdBQUdBO2dCQUNUQSxNQUFNQSxFQUFFQSxJQUFJQSxDQUFDQSxNQUFNQTthQUN0QkEsQ0FBQUE7WUFFREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ25CQSxJQUFJQSxDQUFDQSxNQUFNQSxHQUFHQSxTQUFTQSxDQUFDQSxNQUFNQSxDQUFDQTtnQkFDL0JBLGNBQWNBLENBQUNBLElBQUlBLENBQUNBLEdBQUdBLEdBQUdBLFNBQVNBLEVBQUVBLElBQUlBLENBQUNBLE1BQU1BLEVBQUVBLE9BQU9BLENBQUNBLENBQUNBO2dCQUUzREEsT0FBT0EsU0FBU0EsQ0FBQ0EsTUFBTUEsQ0FBQ0E7WUFDNUJBLENBQUNBO1lBQ0RBLElBQUlBLEtBQUtBLEdBQUdBLEdBQUdBLENBQUNBLElBQUlBLENBQUNBLFNBQVNBLEVBQUVBLElBQUlBLENBQUNBLE1BQU1BLEVBQUVBLEVBQUVBLFdBQVdBLEVBQUVBLElBQUlBLEVBQUVBLENBQUNBLENBQUNBO1lBQ3BFQSxjQUFjQSxDQUFDQSxJQUFJQSxDQUFDQSxHQUFHQSxHQUFHQSxXQUFXQSxFQUFFQSxLQUFLQSxFQUFFQSxPQUFPQSxDQUFDQSxDQUFDQTtZQUN2REEsSUFBSUEsQ0FBQ0EsT0FBT0EsR0FBR0EsS0FBS0EsQ0FBQUE7UUFHeEJBLENBQUNBO1FBQUNBLElBQUlBLENBQUNBLENBQUNBO1lBQ0pBLE1BQU1BLElBQUlBLEtBQUtBLENBQUNBLGdDQUFnQ0EsQ0FBQ0EsQ0FBQUE7UUFDckRBLENBQUNBO0lBTUxBLENBQUNBOztJQUlMUCxZQUFDQTtBQUFEQSxDQW5HQSxBQW1HQ0EsSUFBQTtBQUtELGlCQUFTLEtBQUssQ0FBQSIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGZzIGZyb20gXCJmc1wiO1xuXG5pbXBvcnQgKiBhcyBwYXRoRXhpc3RzIGZyb20gXCJwYXRoLWV4aXN0c1wiO1xuaW1wb3J0ICogYXMgand0IGZyb20gXCJqc29ud2VidG9rZW5cIjtcblxubGV0IHV1aWQgPSByZXF1aXJlKCd1dWlkJyk7XG5sZXQgb3V0cHV0RmlsZVN5bmMgPSByZXF1aXJlKCdvdXRwdXQtZmlsZS1zeW5jJyk7XG5cblxuZnVuY3Rpb24gaW5pdHN5c2lkKHNlcmlhbFBhdGg6IHN0cmluZyxzZXJpPzpzdHJpbmcpOiB7IHNlcmlhbDogc3RyaW5nOyBzZWNyZXQ6IHN0cmluZyB9IHtcbiAgICBsZXQgc2VyaWFsOnN0cmluZztcbiAgICBpZihzZXJpKXtcbiAgICAgICAgc2VyaWFsPXNlcmk7XG4gICAgfSBlbHNle1xuICAgICAgICBzZXJpYWw9dXVpZC52NCgpO1xuICAgIH1cblxuICAgIGxldCBzZWNyZXQ6IHN0cmluZyA9IHV1aWQudjQoKSArIHV1aWQudjQoKTtcblxuICAgIG91dHB1dEZpbGVTeW5jKHNlcmlhbFBhdGggKyAnLy5zZWNyZXQnLCBzZWNyZXQsICd1dGYtOCcpO1xuICAgIG91dHB1dEZpbGVTeW5jKHNlcmlhbFBhdGggKyAnL3NlcmlhbCcsIHNlcmlhbCwgJ3V0Zi04Jyk7XG5cbiAgICByZXR1cm4geyBzZXJpYWw6IHNlcmlhbCwgc2VjcmV0OiBzZWNyZXQgfVxufVxuXG5mdW5jdGlvbiByZWFkU2VyaWFsKHNlcmlhbFBhdGg6IHN0cmluZykge1xuXG4gICAgcmV0dXJuIGZzLnJlYWRGaWxlU3luYyhzZXJpYWxQYXRoICsgJy9zZXJpYWwnLCAndXRmOCcpXG5cbn1cbmZ1bmN0aW9uIHJlYWRTZWNyZXQoc2VyaWFsUGF0aDogc3RyaW5nKSB7XG5cbiAgICByZXR1cm4gZnMucmVhZEZpbGVTeW5jKHNlcmlhbFBhdGggKyAnLy5zZWNyZXQnLCAndXRmOCcpXG5cbn1cbmZ1bmN0aW9uIHJlYWRUcmFja2VyKHNlcmlhbFBhdGg6IHN0cmluZykge1xuXG4gICAgcmV0dXJuIGZzLnJlYWRGaWxlU3luYyhzZXJpYWxQYXRoICsgJy8udHJhY2tlcicsICd1dGY4JylcblxufVxuZnVuY3Rpb24gcmVhZEpzb24oc2VyaWFsUGF0aCkge1xuICAgIGxldCBjb25maWcgPSA8SUpzb24+e307XG5cbiAgICBjb25maWcuc2VjcmV0ID0gcmVhZFNlY3JldChzZXJpYWxQYXRoKTtcbiAgICBjb25maWcuc2VyaWFsID0gcmVhZFNlcmlhbChzZXJpYWxQYXRoKVxuICAgIGlmIChwYXRoRXhpc3RzLnN5bmMoc2VyaWFsUGF0aCArICcvLnRyYWNrZXInKSkge1xuICAgICAgICBjb25maWcudHJhY2tlciA9IHJlYWRUcmFja2VyKHNlcmlhbFBhdGgpXG5cbiAgICB9XG5cbiAgICByZXR1cm4gY29uZmlnXG5cbn1cblxuaW50ZXJmYWNlIElKc29uIHtcbiAgICBzZWNyZXQ6IHN0cmluZztcbiAgICBzZXJpYWw6IHN0cmluZztcbiAgICB0cmFja2VyPzogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgSWlkIHtcbiAgICBkaXI6IHN0cmluZztcbiAgICB0cmFja2VyPzogYm9vbGVhbjtcblxufVxuaW50ZXJmYWNlIElvcHQge1xuICAgIHRyYWNrZXI/OmJvb2xlYW47XG4gICAgc2VyaWFsPzpzdHJpbmdcbn1cbmNsYXNzIFN5c0lEIHtcbiAgICBkaXI6IHN0cmluZztcbiAgICB0cmFja2VyOiBhbnk7XG4gICAgc2VjcmV0OiBzdHJpbmc7XG4gICAgc2VyaWFsOiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3RvcihkaXI6c3RyaW5nLG9wdGlvbnM/OklvcHQpIHtcblxuICAgICAgICBsZXQgY29uZmlnOiBJSnNvbjtcblxuICAgICAgICBpZiAoZGlyKSB7XG4gICAgICAgICAgICB0aGlzLmRpciA9IGRpcjtcblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCd3cm9uZyBkaXInKVxuXG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFvcHRpb25zfHwhb3B0aW9ucy50cmFja2VyKSB7XG5cbiAgICAgICAgICAgIHRoaXMudHJhY2tlciA9IGZhbHNlO1xuXG4gICAgICAgIH0gZWxzZSBpZihvcHRpb25zLnRyYWNrZXIpe1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50cmFja2VyID0gJ3BlbmRpbmcnO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFwYXRoRXhpc3RzLnN5bmModGhpcy5kaXIgKyAnL3NlcmlhbCcpKSB7XG5cbiAgICAgICAgICAgIGNvbmZpZyA9IGluaXRzeXNpZCh0aGlzLmRpcixvcHRpb25zLnNlcmlhbCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25maWcgPSByZWFkSnNvbih0aGlzLmRpcik7XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKHZhciBjID0gMDsgYyA8IE9iamVjdC5rZXlzKGNvbmZpZykubGVuZ3RoOyBjKyspIHtcbiAgICAgICAgICAgIHRoaXNbT2JqZWN0LmtleXMoY29uZmlnKVtjXV0gPSBjb25maWdbT2JqZWN0LmtleXMoY29uZmlnKVtjXV07XG4gICAgICAgIH1cbiAgICB9XG5cblxuXG5cbiAgICByZWFkKCkge1xuICAgICAgICByZXR1cm4gcmVhZEpzb24odGhpcy5kaXIpXG4gICAgfTtcbiAgICBkZWNvZGUoKSB7XG4gICAgICAgIHJldHVybiBqd3QudmVyaWZ5KHRoaXMudHJhY2tlciwgdGhpcy5zZWNyZXQpO1xuICAgIH07XG4gICAgYXV0aCgpIHtcbiAgICAgICAgdmFyIGNvZGUgPSBqd3QudmVyaWZ5KHRoaXMudHJhY2tlciwgdGhpcy5zZWNyZXQpXG4gICAgICAgIGNvZGUuc2VyaWFsID0gcmVhZFNlcmlhbCh0aGlzLmRpcilcbiAgICAgICAgcmV0dXJuIGNvZGU7XG4gICAgfTtcbiAgICBzaWduKGpzb24pIHtcbiAgICAgICAgdmFyIHRva2VuID0gand0LnNpZ24oanNvbiwgdGhpcy5zZWNyZXQpO1xuICAgICAgICByZXR1cm4gdG9rZW5cbiAgICB9O1xuICAgIHZlcmlmeSh0b2tlbiwgbWF4QWdlKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAobWF4QWdlKSB7XG4gICAgICAgICAgICAgICAgdmFyIGRlY29kZWQgPSBqd3QudmVyaWZ5KHRva2VuLCB0aGlzLnNlY3JldCwgeyBtYXhBZ2U6IG1heEFnZSB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFyIGRlY29kZWQgPSBqd3QudmVyaWZ5KHRva2VuLCB0aGlzLnNlY3JldCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZGVjb2RlZFxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIHJldHVybiBlcnJcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICB2YWxpZGF0ZShzZXJpYWwsIG9iamVjdGtleSkge1xuXG5cbiAgICAgICAgaWYgKG9iamVjdGtleSAmJiBzZXJpYWwgPT0gdGhpcy5zZXJpYWwgJiYgdGhpcy50cmFja2VyICYmIHRoaXMudHJhY2tlciA9PSAncGVuZGluZycpIHtcbiAgICAgICAgICAgIHZhciBjb25maWcgPSB7XG4gICAgICAgICAgICAgICAgc2VjcmV0OiB0aGlzLnNlY3JldFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAob2JqZWN0a2V5LnNlcmlhbCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2VyaWFsID0gb2JqZWN0a2V5LnNlcmlhbDtcbiAgICAgICAgICAgICAgICBvdXRwdXRGaWxlU3luYyh0aGlzLmRpciArICcvc2VyaWFsJywgdGhpcy5zZXJpYWwsICd1dGYtOCcpO1xuXG4gICAgICAgICAgICAgICAgZGVsZXRlIG9iamVjdGtleS5zZXJpYWw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgdG9rZW4gPSBqd3Quc2lnbihvYmplY3RrZXksIHRoaXMuc2VjcmV0LCB7IG5vVGltZXN0YW1wOiB0cnVlIH0pO1xuICAgICAgICAgICAgb3V0cHV0RmlsZVN5bmModGhpcy5kaXIgKyAnLy50cmFja2VyJywgdG9rZW4sICd1dGYtOCcpO1xuICAgICAgICAgICAgdGhpcy50cmFja2VyID0gdG9rZW5cbiAgICAgICAgICAgIC8vIHJlc2V0IG9iamVjdFxuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3dyb25nIHNlcmlhbCBvciBqdXN0IHZhbGlkYXRlZCcpXG4gICAgICAgIH1cblxuXG5cbiAgICAgICAgLy8gdmFyIGNvbmZpZz1yZWFkIGZpbGUgc2VyaWFsXG5cbiAgICB9O1xuXG5cblxufVxuXG5cblxuXG5leHBvcnQgPSBTeXNJRFxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
